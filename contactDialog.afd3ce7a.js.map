{"mappings":"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","sources":["src/contactDialog/index.ts","../../node_modules/.pnpm/@parcel+runtime-js@2.8.0/node_modules/@parcel/runtime-js/lib/runtime-76627a958fb3cac9.js"],"sourcesContent":["import tplUrl from 'url:./tpl.html';\nimport './_styles.scss';\n\nexport class ContactDialogCtrl {\n    static grecaptchaScriptLoader: Promise<void>;\n    static templateLoader: Promise<Response>\n\n    private grecaptchaCallbackResolver: (token: string)=> void = () => {};\n    element: HTMLDialogElement;\n\n    constructor () {\n        if (!ContactDialogCtrl.grecaptchaScriptLoader) this.createScriptElement();\n\n        this.createDialogElement();\n    }\n\n    private async createDialogElement () {\n        this.element = document.createElement('dialog');\n\n        if (!ContactDialogCtrl.templateLoader) ContactDialogCtrl.templateLoader = fetch(tplUrl);\n        const tplResponse = await ContactDialogCtrl.templateLoader;\n\n        this.element.innerHTML = await tplResponse.text();\n        this.element.querySelectorAll('input,textarea').forEach(inputEl => {\n            inputEl.setAttribute('placeholder', ' '); // to let 'placeholder-shown' styling to kick in\n        });\n        this.element.querySelector('.dialog__btn-close').addEventListener('click', this.hide.bind(this));\n\n        this.element.querySelector<HTMLFormElement>('.gform').addEventListener('submit', this.onFormSubmit.bind(this))\n    }\n\n    private createScriptElement () {\n        ContactDialogCtrl.grecaptchaScriptLoader = new Promise<void>((resolve) => {\n            const script = document.createElement('script');\n            script.onload = () => {\n                const container = document.createElement('div');\n                container.className = 'grecaptcha-wrapper';\n                document.body.appendChild(container);\n                (window as any).grecaptcha.ready(() => {\n                    (window as any).grecaptcha.render(container, {\n                        sitekey: '6LdQaM8ZAAAAAJwBCtGEYIyh9u6be1rBOlsd-FWj',\n                        size: 'invisible',\n                        callback: (token) => this.grecaptchaCallbackResolver(token)\n                    });\n                    resolve();\n                });\n            };\n            script.src = 'https://www.google.com/recaptcha/api.js?render=explicit';\n            script.defer = true;\n            script.async = true;\n\n            document.body.appendChild(script);\n        });\n    }\n\n    private async executeGrecaptcha () {\n       const token = await new Promise<string>((resolve) => {\n            this.grecaptchaCallbackResolver = resolve;\n           (window as any).grecaptcha.execute();\n        });\n        (window as any).grecaptcha.reset();\n\n        return token;\n    }\n\n    private async sendContactData (data: string, attempt = 0) {\n        return new Promise<void>(async (resolve, reject) => {\n            const url = 'https://script.google.com/macros/s/AKfycbzrISB5QwRuuwGTgkxgKp7DGENDHPcxZTcka2_LRQ0zULSf5Ec/exec?' + data;\n\n            const token = await this.executeGrecaptcha();\n            const req = new XMLHttpRequest();\n            req.open('POST', url + '&token=' + encodeURIComponent(token));\n            req.setRequestHeader('Content-type', 'text/plain;charset=utf-8');\n            req.onreadystatechange = () => {\n                if(req.readyState === 4) {\n                    if (req.status === 200) {\n                        const res = JSON.parse(req.responseText);\n                        if (res.result === 'success') return resolve();\n                        else if (++attempt < 3) resolve(this.sendContactData(data, attempt))\n                        else reject();\n                    } else reject();\n                }\n            }\n            req.send();\n        });\n    }\n\n    isShown () {\n        return this.element.getAttribute('open') === 'open';\n    }\n\n    show() {\n        requestAnimationFrame(() => {\n            this.element.setAttribute('open', 'open');\n        });\n    }\n\n    hide() {\n        this.element.removeAttribute('open');\n    }\n\n    async onFormSubmit (e: Event) {\n        await ContactDialogCtrl.grecaptchaScriptLoader;\n\n        const form = e.currentTarget as HTMLFormElement;\n        const button = form.querySelector('button');\n        button.disabled = true;\n        e.preventDefault();\n\n        const url = Array.prototype.slice.apply(form.querySelectorAll('input,textarea'))\n                .map(\n                    (el: HTMLInputElement | HTMLTextAreaElement) =>\n                    encodeURIComponent(el.name) + '=' + encodeURIComponent(el.value)\n                )\n                .join('&');\n\n        await this.sendContactData(url).then(\n            () => {\n                button.textContent = 'THX!';\n                button.classList.remove('fill');\n                button.classList.add('pe-n');\n            },\n            () => {}\n        );\n        button.disabled = false;\n    }\n}\n","module.exports = require('./helpers/bundle-url').getBundleURL('iGomz') + require('./helpers/bundle-manifest').resolve(\"6kmWC\");"],"names":["parcelHelpers","require","export","exports","ContactDialogCtrl","_tplHtml","grecaptchaCallbackResolver","constructor","grecaptchaScriptLoader","this","createScriptElement","createDialogElement","async","element","document","createElement","templateLoader","fetch","_tplHtmlDefault","default","tplResponse","innerHTML","text","querySelectorAll","forEach","inputEl","setAttribute","querySelector","addEventListener","hide","bind","onFormSubmit","Promise","resolve","script","onload","container","className","body","appendChild","window","grecaptcha","ready","render","sitekey","size","callback","token","src","defer","execute","reset","data","attempt","reject","url","executeGrecaptcha","req","XMLHttpRequest","open","encodeURIComponent","setRequestHeader","onreadystatechange","readyState","status","JSON","parse","responseText","result","sendContactData","send","isShown","getAttribute","show","requestAnimationFrame","removeAttribute","e","form","currentTarget","button","disabled","preventDefault","Array","prototype","slice","apply","map","el","name","value","join","then","textContent","classList","remove","add","module","getBundleURL"],"version":3,"file":"contactDialog.afd3ce7a.js.map"}